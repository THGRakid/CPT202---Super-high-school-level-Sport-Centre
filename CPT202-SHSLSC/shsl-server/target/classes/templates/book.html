<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sports Reservation</title>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style8.css">
    <link rel="stylesheet" href="/static/css/style9.css">
    <script src="/static/js/changecolor.js"></script>
</head>
<body>
<header>
    <div class="logo">
        <img src="/static/img/logo.jpg" alt="rhythm logo">
    </div>
    <nav>
        <ul>
            <li><a th:href="@{/homepage/show}">Home</a></li>
            <li><a th:href="@{/bookPage/show}">Book</a></li>
            <li><a href="#">Event</a></li>
            <li><a href="#">Lesson</a></li>
            <li><a href="#">About us</a></li>
            <li><a href="#">Contact</a></li>
            <div class="register-link">
                <a th:href="@{/user/personalHomepage}">My Account</a>
            </div>
            <li><img src="/static/img/Personal_avatar.jpg" alt="User Avatar" class="avatar"></li>
        </ul>
        <form action="/search" method="GET">
            <input type="text" name="query" placeholder="Please write down">
            <button type="submit"><i class="fas fa-search search-icon"></i></button>
        </form>
    </nav>
</header>

<div class="button-container">
    <button class="sport-button" onclick="showTableById('2')"><i class="fas fa-life-ring"></i> Badminton</button>
    <button class="sport-button" onclick="showTableById('1')"><i class="fas fa-map-pin"></i> Table Tennis</button>
    <button class="sport-button" onclick="showTableById('3')"><i class="fas fa-dumbbell"></i> Fitness room</button>
    <button class="sport-button" onclick="showTableById('4')"><i class="fas fa-water"></i> Swimming</button>
    <button class="sport-button" id="basketball"><i class="fas fa-basketball-ball"></i> Basketball</button>
    <button class="sport-button" id="football"><i class="fas fa-futbol"></i> Football</button>
    <button class="sport-button" id="martial"><i class="fas fa-fist-raised"></i> Martial Art</button>
    <button class="sport-button" id="billiard"><i class="fas fa-bowling-ball"></i> Billiard</button>
    <button class="sport-button" id="golf"><i class="fas fa-golf-ball"></i> Golf</button>
    <button class="sport-button" id="squash"><i class="fas fa-cube"></i> Squash</button>
    <button class="sport-button" id="more"><i class="fas fa-ellipsis-h"></i> More</button>
</div>

<div id="stadiumCardContainer"></div>
<div id="timeBox" class="time-box"></div>
<div id="infoBox" class="info-box"></div>

<!-- 弹窗 -->
<div id="reservationModal" class="modal" hidden>
    <div class="modal-content">
        <span class="close">&times;</span>
        <p>Are you sure you want to reserve this Place?</p>
        <button id="confirmReservation">Yes</button>
        <button id="cancelReservation">No</button>
    </div>
</div>

<script>
    function showStadium(data) {
        let cardHTML = `
            <div class="wrapper">
            <div class="container">
                <div class="card">
                    <div class="box">
                        <div class="img_box">
                            <video id="myVideo" controls src="${data.video}" muted loop autoplay></video>
                        </div>
                    </div>
                    <div class="box">
                        <div class="content">
                            <h2>${data.staName}<br><span>${data.staInfo}</span></h2>
                            <ul>
                                <li>Limit<span>${data.limit}</span></li>
                                <li>Price<span>${data.price}</span></li>
                                <li>Location<span>${data.location}</span></li>
                            </ul>
                            <button class="view-places" onclick="displayTimeBox(${data.staId})">View Places</button>
                        </div>
                    </div>
                    <div class="circle">
                        <div class="img_box">
                            <img src="${data.staPicture}" alt="Stadium Image">
                        </div>
                    </div>
                </div>
            </div>
            </div>
        `;

        document.getElementById('stadiumCardContainer').innerHTML = '';
        document.getElementById('stadiumCardContainer').innerHTML += cardHTML;
    }

    function showTableById(id) {
        $.ajax({
            type: "GET",
            dataType: "json",
            url: '/stadium/show/' + id,
            success: function (result) {
                if (result.code === 1) {
                    showStadium(result.data);
                } else {
                    alert(result.msg);
                }
            }
        });
    }

    function displayTimeBox(data) {
        const staId = data;
        const oldTimeBox = document.getElementById('timeBox');
        oldTimeBox.innerHTML = '';

        const today = new Date();
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        for (let i = 0; i < 7; i++) {
            const date = new Date(today);
            date.setDate(today.getDate() + i);

            const dayOfWeek = days[date.getDay()];
            const dayOfMonth = date.getDate();
            const month = date.getMonth() + 1;

            const dateElement = document.createElement('button');
            dateElement.classList.add('time-button');
            dateElement.textContent = `${dayOfWeek}, ${month}/${dayOfMonth}`;
            dateElement.onclick = function() {
                const selectedDate = document.querySelector('.time-button.active');
                if (selectedDate) {
                    selectedDate.classList.remove('active');
                }
                this.classList.add('active');
                displayInfoBox(dayOfWeek, staId);
            };
            oldTimeBox.appendChild(dateElement);
        }
    }

    function displayInfoBox(dayOfWeek, staId) {
        const oldInfoBox = document.getElementById('infoBox');
        oldInfoBox.innerHTML = '';

        // 根据dayOfWeek映射到具体日期
        const days = {
            Sun: 'Sunday',
            Mon: 'Monday',
            Tue: 'Tuesday',
            Wed: 'Wednesday',
            Thu: 'Thursday',
            Fri: 'Friday',
            Sat: 'Saturday'
        };
        const selectedDay = days[dayOfWeek];

        // 发送AJAX请求到后端获取数据
        $.ajax({
            type: "GET",
            dataType: "json",
            url: '/timeslot/getPlacesByDate',
            data: { day: selectedDay , staId: staId},
            success: function (result) {
                if (result.code === 1) {
                    const infoItems = result.data;
                    infoItems.forEach(info => {
                        const infoItem = document.createElement('div');
                        infoItem.classList.add('info-item');
                        if (info.booked) {
                            infoItem.classList.add('booked');
                        }
                        infoItem.innerHTML = `
                            <p>Book ID: ${info.slotId}</p>
                            <p>Place ID: ${info.placeId}</p>
                            <p>Start Time: ${info.startTime}</p>
                            <p>End Time: ${info.endTime}</p>
                            <p>Status: ${info.booked?  'Booked': 'Free'}</p>
                        `;
                        if (!info.booked) {
                            const reserveButton = document.createElement('button');
                            reserveButton.classList.add('reserve-button');
                            reserveButton.textContent = 'BOOK NOW';
                            reserveButton.onclick = function() {
                                reserveSlot(info.slotId);
                            };
                            infoItem.appendChild(reserveButton);
                        }

                        oldInfoBox.appendChild(infoItem);
                    });
                } else {
                    alert(result.msg);
                }
            },
        });
    }

    function reserveSlot(slotId) {
        var data = {
            "slotId": slotId
        };
        $.ajax({
            type: "POST",
            dataType: "json",
            url: '/reservation/make',
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function(response) {
                if (response.code === 1) {
                    alert('Book Successfully!');
                    const activeButton = document.querySelector('.time-button.active');
                    if (activeButton) {
                        displayInfoBox(activeButton.textContent.split(', ')[0].substring(0, 3));
                    }
                } else {
                    alert(response.msg);
                }
            },
            error: function() {
                alert('Error reserving slot');
            }
        });
    }


</script>

</body>
</html>
